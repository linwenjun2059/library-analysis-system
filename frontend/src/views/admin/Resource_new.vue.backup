// æ–°çš„scriptéƒ¨åˆ†
import { ref, computed, nextTick, watch, onMounted, onUnmounted } from 'vue'
import { getResourceOptimization } from '@/api/statistics'
import { ElMessage } from 'element-plus'
import * as echarts from 'echarts'

const loading = ref(false)
const activeTab = ref('overview')
const pieChartRef = ref(null)
const subjectChartRef = ref(null)
const priorityChartRef = ref(null)
const borrowChartRef = ref(null)

let pieChart = null
let subjectChart = null
let priorityChart = null
let borrowChart = null

const allResourceData = ref([])

// ä½¿ç”¨refå­˜å‚¨åˆ†ç±»åŽçš„æ•°æ®
const purchaseData = ref([])
const eliminateData = ref([])
const transferData = ref([])
const purchaseCount = ref(0)
const eliminateCount = ref(0)
const transferCount = ref(0)

// ç­›é€‰æ¡ä»¶
const purchaseSubjectFilter = ref('')
const purchasePriorityFilter = ref(null)
const eliminateSubjectFilter = ref('')
const eliminateSearchText = ref('')

// è®¡ç®—å±žæ€§
const avgPriority = computed(() => {
  if (allResourceData.value.length === 0) return 0
  const sum = allResourceData.value.reduce((acc, item) => acc + (item.priority || 0), 0)
  return sum / allResourceData.value.length
})

const totalBorrowCount = computed(() => {
  return allResourceData.value.reduce((acc, item) => acc + (item.borrowCount || 0), 0)
})

const purchaseSubjects = computed(() => {
  const subjects = new Set()
  purchaseData.value.forEach(item => {
    if (item.subject) subjects.add(item.subject)
  })
  return Array.from(subjects).sort()
})

const eliminateSubjects = computed(() => {
  const subjects = new Set()
  eliminateData.value.forEach(item => {
    if (item.subject) subjects.add(item.subject)
  })
  return Array.from(subjects).sort()
})

// è¿‡æ»¤åŽçš„æ•°æ®
const filteredPurchaseData = computed(() => {
  let data = purchaseData.value
  
  if (purchaseSubjectFilter.value) {
    data = data.filter(item => item.subject === purchaseSubjectFilter.value)
  }
  
  if (purchasePriorityFilter.value !== null) {
    data = data.filter(item => item.priority >= purchasePriorityFilter.value)
  }
  
  return data
})

const filteredEliminateData = computed(() => {
  let data = eliminateData.value
  
  if (eliminateSubjectFilter.value) {
    data = data.filter(item => item.subject === eliminateSubjectFilter.value)
  }
  
  if (eliminateSearchText.value) {
    const searchText = eliminateSearchText.value.toLowerCase()
    data = data.filter(item => 
      (item.title && item.title.toLowerCase().includes(searchText)) ||
      (item.author && item.author.toLowerCase().includes(searchText))
    )
  }
  
  return data
})

// åˆ†ç±»æ•°æ®çš„å‡½æ•°
const categorizeData = (data) => {
  purchaseData.value = data.filter(item => 
    item.optimizationType === 'è¶…çº§çƒ­é—¨' || item.optimizationType === 'çƒ­é—¨å›¾ä¹¦'
  )
  
  eliminateData.value = data.filter(item => 
    item.optimizationType === 'å†·é—¨å›¾ä¹¦' || item.optimizationType === 'åƒµå°¸å›¾ä¹¦'
  )
  
  transferData.value = data.filter(item => 
    item.optimizationType === 'è°ƒæ‹¨å»ºè®®'
  )
  
  purchaseCount.value = purchaseData.value.length
  eliminateCount.value = eliminateData.value.length
  transferCount.value = transferData.value.length
}

const loadData = async () => {
  try {
    loading.value = true
    console.log('ðŸ”„ å¼€å§‹åŠ è½½èµ„æºä¼˜åŒ–æ•°æ®...')
    
    const res = await getResourceOptimization({})
    let data = res.data || []
    
    console.log('ðŸ“¥ æ”¶åˆ°æ•°æ®:', data.length, 'æ¡')
    
    // å®‰å…¨é™åˆ¶
    if (data.length > 200) {
      console.warn('âš ï¸ æ•°æ®é‡è¿‡å¤§ï¼Œæˆªæ–­è‡³200æ¡')
      data = data.slice(0, 200)
      ElMessage.warning('æ•°æ®é‡è¾ƒå¤§ï¼Œä»…æ˜¾ç¤ºå‰200æ¡ä¼˜å…ˆçº§æœ€é«˜çš„å»ºè®®')
    }
    
    allResourceData.value = data
    
    // åˆ†ç±»æ•°æ®
    console.log('ðŸ“Š å¼€å§‹åˆ†ç±»æ•°æ®...')
    categorizeData(data)
    console.log('âœ… åˆ†ç±»å®Œæˆ:', {
      å¢žè´­: purchaseCount.value,
      æ·˜æ±°: eliminateCount.value,
      è°ƒæ‹¨: transferCount.value
    })
    
    // å»¶è¿Ÿåˆå§‹åŒ–å›¾è¡¨
    await nextTick()
    if (activeTab.value === 'overview') {
      console.log('ðŸ“ˆ åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨...')
      initAllCharts()
    }
    
    console.log('âœ… èµ„æºä¼˜åŒ–æ•°æ®åŠ è½½æˆåŠŸ')
  } catch (error) {
    console.error('âŒ åŠ è½½èµ„æºä¼˜åŒ–æ•°æ®å¤±è´¥ï¼š', error)
    ElMessage.error('åŠ è½½èµ„æºä¼˜åŒ–æ•°æ®å¤±è´¥: ' + error.message)
  } finally {
    loading.value = false
  }
}

const initAllCharts = () => {
  initPieChart()
  initSubjectChart()
  initPriorityChart()
  initBorrowChart()
}

const initPieChart = () => {
  if (!pieChartRef.value) return
  
  if (!pieChart) {
    pieChart = echarts.init(pieChartRef.value)
  }
  
  const option = {
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c}æœ¬ ({d}%)'
    },
    legend: {
      orient: 'vertical',
      left: 'left'
    },
    series: [{
      name: 'ä¼˜åŒ–ç±»åž‹',
      type: 'pie',
      radius: ['40%', '70%'],
      center: ['60%', '50%'],
      data: [
        { value: purchaseCount.value, name: 'å¢žè´­å»ºè®®', itemStyle: { color: '#67c23a' } },
        { value: eliminateCount.value, name: 'æ·˜æ±°å»ºè®®', itemStyle: { color: '#f56c6c' } },
        { value: transferCount.value, name: 'è°ƒæ‹¨å»ºè®®', itemStyle: { color: '#e6a23c' } }
      ],
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      },
      label: {
        formatter: '{b}\n{c}æœ¬ ({d}%)'
      }
    }]
  }
  
  pieChart.setOption(option)
}

const initSubjectChart = () => {
  if (!subjectChartRef.value || allResourceData.value.length === 0) return
  
  if (!subjectChart) {
    subjectChart = echarts.init(subjectChartRef.value)
  }
  
  // ç»Ÿè®¡ä¸»é¢˜åˆ†å¸ƒ
  const subjectStats = {}
  allResourceData.value.forEach(item => {
    if (item.subject) {
      subjectStats[item.subject] = (subjectStats[item.subject] || 0) + 1
    }
  })
  
  const top10 = Object.entries(subjectStats)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .reverse()
  
  const option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' },
      formatter: (params) => {
        return `${params[0].name}<br/>æ•°é‡: ${params[0].value}æœ¬`
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'value'
    },
    yAxis: {
      type: 'category',
      data: top10.map(item => item[0])
    },
    series: [{
      name: 'æ•°é‡',
      type: 'bar',
      data: top10.map(item => item[1]),
      itemStyle: {
        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
          { offset: 0, color: '#83bff6' },
          { offset: 1, color: '#188df0' }
        ])
      },
      label: {
        show: true,
        position: 'right'
      }
    }]
  }
  
  subjectChart.setOption(option)
}

const initPriorityChart = () => {
  if (!priorityChartRef.value || allResourceData.value.length === 0) return
  
  if (!priorityChart) {
    priorityChart = echarts.init(priorityChartRef.value)
  }
  
  // ç»Ÿè®¡ä¼˜å…ˆçº§åˆ†å¸ƒ
  const priorityStats = {
    'é«˜ä¼˜å…ˆçº§(â‰¥8)': 0,
    'ä¸­ä¼˜å…ˆçº§(5-7)': 0,
    'ä½Žä¼˜å…ˆçº§(<5)': 0
  }
  
  allResourceData.value.forEach(item => {
    if (item.priority >= 8) {
      priorityStats['é«˜ä¼˜å…ˆçº§(â‰¥8)']++
    } else if (item.priority >= 5) {
      priorityStats['ä¸­ä¼˜å…ˆçº§(5-7)']++
    } else {
      priorityStats['ä½Žä¼˜å…ˆçº§(<5)']++
    }
  })
  
  const option = {
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c}æœ¬ ({d}%)'
    },
    series: [{
      name: 'ä¼˜å…ˆçº§',
      type: 'pie',
      radius: '60%',
      data: [
        { value: priorityStats['é«˜ä¼˜å…ˆçº§(â‰¥8)'], name: 'é«˜ä¼˜å…ˆçº§(â‰¥8)', itemStyle: { color: '#f56c6c' } },
        { value: priorityStats['ä¸­ä¼˜å…ˆçº§(5-7)'], name: 'ä¸­ä¼˜å…ˆçº§(5-7)', itemStyle: { color: '#e6a23c' } },
        { value: priorityStats['ä½Žä¼˜å…ˆçº§(<5)'], name: 'ä½Žä¼˜å…ˆçº§(<5)', itemStyle: { color: '#909399' } }
      ],
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      }
    }]
  }
  
  priorityChart.setOption(option)
}

const initBorrowChart = () => {
  if (!borrowChartRef.value || allResourceData.value.length === 0) return
  
  if (!borrowChart) {
    borrowChart = echarts.init(borrowChartRef.value)
  }
  
  // ç»Ÿè®¡å€Ÿé˜…æ¬¡æ•°åˆ†å¸ƒ
  const borrowRanges = {
    '0æ¬¡': 0,
    '1-5æ¬¡': 0,
    '6-10æ¬¡': 0,
    '11-20æ¬¡': 0,
    '20æ¬¡ä»¥ä¸Š': 0
  }
  
  allResourceData.value.forEach(item => {
    const count = item.borrowCount || 0
    if (count === 0) {
      borrowRanges['0æ¬¡']++
    } else if (count <= 5) {
      borrowRanges['1-5æ¬¡']++
    } else if (count <= 10) {
      borrowRanges['6-10æ¬¡']++
    } else if (count <= 20) {
      borrowRanges['11-20æ¬¡']++
    } else {
      borrowRanges['20æ¬¡ä»¥ä¸Š']++
    }
  })
  
  const option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' }
    },
    xAxis: {
      type: 'category',
      data: Object.keys(borrowRanges)
    },
    yAxis: {
      type: 'value',
      name: 'å›¾ä¹¦æ•°é‡'
    },
    series: [{
      name: 'æ•°é‡',
      type: 'bar',
      data: Object.values(borrowRanges),
      itemStyle: {
        color: (params) => {
          const colors = ['#909399', '#67c23a', '#409eff', '#e6a23c', '#f56c6c']
          return colors[params.dataIndex]
        }
      },
      label: {
        show: true,
        position: 'top'
      }
    }]
  }
  
  borrowChart.setOption(option)
}

const handleTabChange = (tabName) => {
  if (tabName === 'overview') {
    nextTick(() => {
      initAllCharts()
    })
  }
}

watch(activeTab, (newVal) => {
  if (newVal === 'overview') {
    setTimeout(() => {
      initAllCharts()
    }, 100)
  }
})

onMounted(() => {
  loadData()
  
  window.addEventListener('resize', () => {
    pieChart?.resize()
    subjectChart?.resize()
    priorityChart?.resize()
    borrowChart?.resize()
  })
})

onUnmounted(() => {
  pieChart?.dispose()
  subjectChart?.dispose()
  priorityChart?.dispose()
  borrowChart?.dispose()
})
